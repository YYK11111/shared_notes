# API接口文档

## 项目概述

这是一个基于Node.js和Express构建的笔记管理系统后端API，提供完整的笔记管理、分类管理、用户认证和权限控制功能，为前端应用提供数据支持和业务逻辑。

## 基础信息

- 服务器地址：`http://localhost:3000`（开发环境）
- API前缀：所有API接口均以 `/api` 开头
- 请求/响应格式：JSON
- 认证方式：JWT Token（Bearer Token）
- 开发框架：Express.js
- 数据库：MySQL

## 响应格式

所有API响应遵循统一格式：

```json
{
  "code": 200, // 状态码，200表示成功，非200表示失败
  "data": {}, // 响应数据，根据不同接口返回不同结构
  "msg": "操作成功" // 消息提示，用于前端显示
}
```

## 认证接口

### 获取验证码

- **URL**: `/api/auth/captcha`
- **方法**: `GET`
- **认证**: 不需要
- **返回数据**: SVG图片（Content-Type: image/svg+xml）
- **响应头**: 
  - `X-Captcha-Id`: 验证码ID，用于验证时使用
- **错误码**: 
  - 500: 获取验证码失败，请稍后重试
- **说明**: 生成图形验证码，用于登录验证

### 登录

- **URL**: `/api/auth/login`
- **方法**: `POST`
- **认证**: 不需要
- **请求参数**: 
  - `username`: 用户名（必填）
  - `password`: 密码（必填）
  - `captcha`: 验证码（必填）
  - `captchaId`: 验证码ID（必填）
- **返回数据**: 
  ```json
  {
    "code": 200,
    "data": {
      "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...", // JWT访问令牌
      "refreshToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...", // 刷新令牌
      "admin": {
        "id": 1,
        "username": "admin",
        "nickname": "超级管理员",
        "role": "超级管理员",
        "permissions": ["admin:list", "admin:create", "note:edit"]
      }
    },
    "msg": "登录成功"
  }
  ```
- **错误码**: 
  - 400: 用户名、密码和验证码不能为空
  - 400: 验证码错误或已过期，请刷新后重试
  - 401: 用户名或密码错误
  - 401: 账户已禁用，请联系超级管理员
- **说明**: 
  - 自动记录登录日志，包括IP地址和用户代理信息
  - token默认有效期1小时，refreshToken默认有效期7天

### 登出

- **URL**: `/api/auth/logout`
- **方法**: `POST`
- **认证**: 需要
- **返回数据**: 
  ```json
  {
    "code": 200,
    "data": null,
    "msg": "登出成功"
  }
  ```
- **说明**: 前端登出时调用，清理会话状态

### 修改密码

- **URL**: `/api/auth/change-password`
- **方法**: `POST`
- **认证**: 需要
- **请求参数**: 
  - `currentPassword`: 当前密码（必填）
  - `newPassword`: 新密码（必填，长度不能少于6位）
- **返回数据**: 
  ```json
  {
    "code": 200,
    "data": null,
    "msg": "密码修改成功，请重新登录"
  }
  ```
- **错误码**: 
  - 400: 当前密码和新密码不能为空
  - 400: 新密码长度不能少于6位
  - 400: 当前密码错误
  - 401: 未授权，请先登录
  - 401: 登录已过期，请重新登录
  - 404: 管理员不存在
- **说明**: 自动记录管理员操作日志

### 重置密码接口（超级管理员使用）

- **URL**: `/api/auth/reset-password`
- **方法**: `POST`
- **认证**: 需要（超级管理员权限）
- **请求参数**: 
  - `adminId`: 管理员ID（必填）
  - `newPassword`: 新密码（必填，长度不能少于6位）
- **返回数据**: 
  ```json
  {
    "code": 200,
    "data": null,
    "msg": "密码重置成功"
  }
  ```
- **错误码**: 
  - 400: 管理员ID和新密码不能为空
  - 400: 新密码长度不能少于6位
  - 401: 未授权，请先登录
  - 401: 登录已过期，请重新登录
  - 403: 只有超级管理员可以重置密码
  - 404: 目标管理员不存在
- **说明**: 自动记录管理员操作日志

### 刷新令牌

- **URL**: `/api/auth/refresh`
- **方法**: `POST`
- **认证**: 需要（在请求头中提供现有令牌）
- **返回数据**: 
  ```json
  {
    "code": 200,
    "data": {
      "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
      "refreshToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
    },
    "msg": "令牌刷新成功"
  }
  ```
- **错误码**: 
  - 401: 未提供令牌
  - 401: 无效的令牌
  - 401: 用户不存在或已禁用
- **说明**: 
  - 允许使用已过期的令牌进行刷新
  - 会重新生成新的访问令牌和刷新令牌

## 分类管理接口

### 获取分类列表

- **URL**: `/api/categories`
- **方法**: `GET`
- **认证**: 需要
- **请求参数**: 
  - `status`: 状态（可选，1表示启用，0表示禁用）
- **返回数据**: 
  ```json
  {
    "code": 200,
    "data": {
      "list": [
        {
          "id": 1,
          "name": "技术分享",
          "description": "分享技术相关内容",
          "parent_id": 0,
          "priority": 1,
          "status": 1,
          "icon": null,
          "created_at": "2023-01-01 10:00:00",
          "updated_at": "2023-01-01 10:00:00",
          "children": [
            {
              "id": 2,
              "name": "前端开发",
              "description": "前端技术相关内容",
              "parent_id": 1,
              "priority": 2,
              "status": 1,
              "icon": null,
              "created_at": "2023-01-01 11:00:00",
              "updated_at": "2023-01-01 11:00:00"
            }
          ]
        }
      ],
      "total": 2
    },
    "msg": "获取分类列表成功"
  }
  ```
- **说明**: 返回树形结构的分类列表，按优先级和ID升序排列

### 获取分类详情

- **URL**: `/api/categories/:id`
- **方法**: `GET`
- **认证**: 需要
- **返回数据**: 
  ```json
  {
    "code": 200,
    "data": {
      "id": 1,
      "name": "技术分享",
      "description": "分享技术相关内容",
      "parent_id": 0,
      "priority": 1,
      "status": 1,
      "icon": null,
      "created_at": "2023-01-01 10:00:00",
      "updated_at": "2023-01-01 10:00:00"
    },
    "msg": "获取分类详情成功"
  }
  ```
- **错误码**: 
  - 404: 分类不存在

### 创建分类

- **URL**: `/api/categories`
- **方法**: `POST`
- **认证**: 需要
- **请求参数**: 
  - `name`: 分类名称（必填）
  - `description`: 描述（可选）
  - `parent_id` 或 `parentId`: 父分类ID（可选，0表示顶级分类）
  - `priority`: 优先级（可选，1-10之间，默认10）
  - `status`: 状态（可选，默认1）
  - `icon`: 图标（可选）
- **返回数据**: 
  ```json
  {
    "code": 201,
    "data": {
      "id": 3
    },
    "msg": "创建分类成功"
  }
  ```
- **错误码**: 
  - 400: 分类名称不能为空
  - 400: 父分类不存在
  - 400: 优先级必须在1-10之间
- **说明**: 自动记录管理员操作日志

### 更新分类

- **URL**: `/api/categories/:id`
- **方法**: `PUT`
- **认证**: 需要
- **请求参数**: 
  - `name`: 分类名称（必填）
  - `description`: 描述（可选）
  - `parent_id` 或 `parentId`: 父分类ID（可选，0表示顶级分类）
  - `priority`: 优先级（可选，1-10之间）
  - `status`: 状态（可选）
  - `icon`: 图标（可选）
- **返回数据**: 
  ```json
  {
    "code": 200,
    "data": null,
    "msg": "更新分类成功"
  }
  ```
- **错误码**: 
  - 400: 分类名称不能为空
  - 400: 分类不能设置自身为父分类
  - 400: 分类不能设置自身或子孙分类为父分类
  - 400: 父分类不存在
  - 400: 优先级必须在1-10之间
  - 404: 分类不存在
- **说明**: 自动记录管理员操作日志

### 删除分类

- **URL**: `/api/categories/:id`
- **方法**: `DELETE`
- **认证**: 需要
- **返回数据**: 
  ```json
  {
    "code": 200,
    "data": null,
    "msg": "删除分类成功"
  }
  ```
- **错误码**: 
  - 400: 该分类下存在子分类，请先删除子分类
  - 400: 该分类下存在笔记，请先移除笔记关联
  - 404: 分类不存在
- **说明**: 自动记录管理员操作日志

### 获取分类笔记数量统计

- **URL**: `/api/categories/stats/note-count`
- **方法**: `GET`
- **认证**: 需要
- **返回数据**: 
  ```json
  {
    "code": 200,
    "data": [
      {"id": 1, "name": "技术分享", "note_count": 25},
      {"id": 2, "name": "前端开发", "note_count": 15}
    ],
    "msg": "获取分类统计数据成功"
  }
  ```
- **说明**: 返回每个分类及其关联的笔记数量，按笔记数量降序排列

## 笔记管理接口

### 获取笔记列表

- **URL**: `/api/notes`
- **方法**: `GET`
- **认证**: 需要
- **请求参数**: 
  - `page`: 页码（默认1）
  - `pageSize`: 每页数量（默认10）
  - `keyword`: 搜索关键词（可选，模糊搜索标题和内容）
  - `categoryId`: 分类ID（可选）
  - `status`: 状态（可选，0表示禁用，1表示启用）
  - `startDate`: 开始日期（可选，格式：YYYY-MM-DD）
  - `endDate`: 结束日期（可选，格式：YYYY-MM-DD）
- **返回数据**: 
  ```json
  {
    "code": 200,
    "data": {
      "list": [
        {
          "id": 1,
          "title": "React入门教程",
          "content": "React是一个用于构建用户界面的JavaScript库...",
          "cover_image": "/uploads/cover-1623456789012.jpg",
          "status": 1,
          "is_top": 0,
          "top_expire_time": null,
          "is_home_recommend": 1,
          "is_week_selection": 0,
          "is_month_recommend": 0,
          "view_count": 1234,
          "created_at": "2023-01-01 10:00:00",
          "updated_at": "2023-01-02 15:30:00",
          "category_ids": "1,2",
          "category_names": "技术分享,前端开发"
        }
      ],
      "total": 100,
      "page": 1,
      "pageSize": 10,
      "totalPages": 10
    },
    "msg": "获取笔记列表成功"
  }
  ```
- **错误码**: 
  - 500: 获取笔记列表失败，请稍后重试

### 获取笔记详情

- **URL**: `/api/notes/:id`
- **方法**: `GET`
- **认证**: 需要
- **返回数据**: 
  ```json
  {
    "code": 200,
    "data": {
      "id": 1,
      "title": "React入门教程",
      "content": "React是一个用于构建用户界面的JavaScript库...",
      "cover_image": "/uploads/cover-1623456789012.jpg",
      "status": 1,
      "is_top": 0,
      "top_expire_time": null,
      "is_home_recommend": 1,
      "is_week_selection": 0,
      "is_month_recommend": 0,
      "view_count": 1234,
      "created_at": "2023-01-01 10:00:00",
      "updated_at": "2023-01-02 15:30:00",
      "categories": [
        {"id": 1, "name": "技术分享"},
        {"id": 2, "name": "前端开发"}
      ]
    },
    "msg": "获取笔记成功"
  }
  ```
- **错误码**: 
  - 404: 笔记不存在
  - 500: 获取笔记失败，请稍后重试

### 创建笔记

- **URL**: `/api/notes`
- **方法**: `POST`
- **认证**: 需要
- **响应状态码**: 201（成功创建）
- **请求参数**: 
  - `title`: 标题（必填）
  - `content`: 内容（必填）
  - `category_ids`: 分类ID数组（可选，格式：逗号分隔的字符串或数组）
  - `status`: 状态（可选，0表示禁用，1表示启用）
  - `is_top`: 是否置顶（可选，0表示否，1表示是）
  - `top_expire_time`: 置顶过期时间（可选，格式：YYYY-MM-DD HH:mm:ss）
  - `is_home_recommend`: 是否首页推荐（可选，0表示否，1表示是）
  - `is_week_selection`: 是否本周精选（可选，0表示否，1表示是）
  - `is_month_recommend`: 是否月度推荐（可选，0表示否，1表示是）
  - `cover_image`: 封面图片（文件上传，可选，支持JPG、PNG、GIF格式，最大5MB）
- **返回数据**: 
  ```json
  {
    "code": 201,
    "data": {"id": 10},
    "msg": "创建笔记成功"
  }
  ```
- **错误码**: 
  - 400: 标题和内容不能为空
  - 400: 只支持JPG、PNG、GIF格式的图片文件
  - 500: 创建笔记失败，请稍后重试
- **说明**: 
  - 自动记录管理员操作日志
  - 支持事务处理，确保数据一致性

### 更新笔记

- **URL**: `/api/notes/:id`
- **方法**: `PUT`
- **认证**: 需要
- **请求参数**: 同创建笔记，增加以下参数
  - `delete_cover`: 是否删除封面图片（可选，设置为'true'时删除现有封面）
- **返回数据**: 
  ```json
  {
    "code": 200,
    "data": null,
    "msg": "更新笔记成功"
  }
  ```
- **错误码**: 
  - 400: 标题和内容不能为空
  - 400: 只支持JPG、PNG、GIF格式的图片文件
  - 404: 笔记不存在
  - 500: 更新笔记失败，请稍后重试
- **说明**: 
  - 自动记录管理员操作日志
  - 支持事务处理，确保数据一致性
  - 支持封面图片的更新和删除

### 删除笔记

- **URL**: `/api/notes/:id`
- **方法**: `DELETE`
- **认证**: 需要
- **返回数据**: 
  ```json
  {
    "code": 200,
    "data": null,
    "msg": "删除笔记成功"
  }
  ```
- **说明**: 
  - 删除笔记时会同时删除相关的分类关联和封面图片文件
  - 自动记录管理员操作日志
  - 支持事务处理
- **错误码**: 
  - 404: 笔记不存在
  - 500: 删除笔记失败，请稍后重试

### 批量删除笔记

- **URL**: `/api/notes/batch-delete`
- **方法**: `POST`
- **认证**: 需要
- **请求参数**: 
  - `ids`: 笔记ID数组（必填）
- **返回数据**: 
  ```json
  {
    "code": 200,
    "data": null,
    "msg": "批量删除成功"
  }
  ```
- **说明**: 
  - 删除笔记时会同时删除相关分类关联和封面图片文件
  - 自动记录管理员操作日志
  - 支持事务处理
- **错误码**: 
  - 400: 请选择要删除的笔记
  - 500: 批量删除失败，请稍后重试

### 批量修改笔记状态

- **URL**: `/api/notes/batch-update-status`
- **方法**: `POST`
- **认证**: 需要
- **请求参数**: 
  - `ids`: 笔记ID数组（必填）
  - `status`: 目标状态（必填，0表示禁用，1表示启用）
- **返回数据**: 
  ```json
  {
    "code": 200,
    "data": null,
    "msg": "批量修改成功"
  }
  ```
- **说明**: 自动记录管理员操作日志
- **错误码**: 
  - 400: 请选择要操作的笔记
  - 400: 请指定状态
  - 500: 批量修改失败，请稍后重试

### 切换笔记置顶状态

- **URL**: `/api/notes/toggle-top/:id`
- **方法**: `PUT`
- **认证**: 需要
- **返回数据**: 
  ```json
  {
    "code": 200,
    "data": {"is_top": 1, "top_expire_time": "2023-01-10 23:59:59"},
    "msg": "置顶成功"
  }
  ```
- **说明**: 自动切换笔记的置顶状态，设置置顶时自动设置7天过期时间
- **错误码**: 
  - 404: 笔记不存在
  - 500: 切换置顶状态失败，请稍后重试

### 编辑器图片上传

- **URL**: `/api/notes/upload-image`
- **方法**: `POST`
- **认证**: 需要
- **请求参数**: 
  - `file`: 图片文件（必填，FormData格式，支持JPG、PNG、GIF格式，最大5MB）
- **返回数据**: 
  ```json
  {
    "code": 200,
    "data": {"url": "/uploads/image-1623456789012.jpg"},
    "msg": "图片上传成功"
  }
  ```
- **说明**: 用于编辑器中上传图片，返回图片的访问URL
- **错误码**: 
  - 400: 请上传图片文件
  - 400: 只支持JPG、PNG、GIF格式的图片文件
  - 400: 图片文件大小不能超过5MB
  - 500: 图片上传失败，请稍后重试

### 统计笔记数据

- **URL**: `/api/notes/stats/overview`
- **方法**: `GET`
- **认证**: 需要
- **请求参数**: 
  - `startDate`: 开始日期（可选，格式：YYYY-MM-DD）
  - `endDate`: 结束日期（可选，格式：YYYY-MM-DD）
- **返回数据**: 
  ```json
  {
    "code": 200,
    "data": {
      "total": 1000,
      "active": 850,
      "top": 50,
      "recommended": 120
    },
    "msg": "获取统计数据成功"
  }
  ```
- **错误码**: 
  - 500: 获取统计数据失败，请稍后重试

### 笔记统计详情

- **URL**: `/api/notes/stats/detail`
- **方法**: `GET`
- **认证**: 需要
- **请求参数**: 
  - `noteId`: 笔记ID（必填）
  - `timeRange`: 时间范围（可选，默认7d，可选值：1d, 7d, 30d, 90d）
  - `type`: 统计类型（可选，默认views，可选值：views, exposure, conversion_rate）
- **返回数据**: 
  ```json
  {
    "code": 200,
    "data": {
      "dateStats": [
        {"date": "2023-01-01", "value": 120},
        {"date": "2023-01-02", "value": 150}
      ],
      "total": 1250,
      "average": 178.57
    },
    "msg": "获取统计详情成功"
  }
  ```
- **错误码**: 
  - 400: 请指定笔记ID
  - 400: 无效的时间范围
  - 400: 无效的统计类型
  - 500: 获取统计详情失败，请稍后重试

### 批量笔记统计接口（根据统计指标筛选笔记）

- **URL**: `/api/notes/stats/filter`
- **方法**: `POST`
- **认证**: 需要
- **请求参数**: 
  - `condition`: 筛选条件对象（必填）
  - `timeRange`: 时间范围（可选，默认7d）
  - `page`: 页码（可选，默认1）
  - `pageSize`: 每页数量（可选，默认10）
- **返回数据**: 
  ```json
  {
    "code": 200,
    "data": {
      "list": [
        {
          "id": 1,
          "title": "React入门教程",
          "status": 1,
          "views_count": 1234,
          "exposure_count": 5678,
          "conversion_rate": 21.73
        }
      ],
      "total": 50,
      "page": 1,
      "pageSize": 10,
      "totalPages": 5
    },
    "msg": "获取筛选笔记列表成功"
  }
  ```
- **错误码**: 
  - 400: 请提供有效的筛选条件
  - 500: 获取筛选笔记列表失败，请稍后重试

## 错误码说明

| 错误码 | 含义 | 说明 |
|-------|------|------|
| 400 | 请求参数错误 | 通常是必填参数缺失、参数格式错误或参数值不合法 |
| 401 | 未授权 | 通常是未提供令牌、令牌过期或令牌无效 |
| 403 | 权限不足 | 用户没有权限执行该操作 |
| 404 | 资源不存在 | 请求的资源（如笔记、分类等）不存在 |
| 500 | 服务器错误 | 服务器内部错误，通常是数据库操作或其他服务错误 |

## 安全注意事项

1. 所有API调用请使用HTTPS协议（生产环境）
2. 请妥善保管JWT令牌，避免泄露
3. 令牌过期后，请使用刷新令牌获取新的访问令牌
4. 敏感操作（如删除、修改）都有操作日志记录
5. 图片上传有格式和大小限制，防止恶意文件上传
6. 重要操作都支持事务处理，确保数据一致性

## 版本信息

- 版本号：v1.0.0
- 最后更新：2023-01-10